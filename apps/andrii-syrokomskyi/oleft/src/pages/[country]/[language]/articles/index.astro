---
import type {
  ArticleEntry,
  ArticlesPageEntry,
  ArticlesPageEntryMetaItem,
} from "../../../../../bcms/types/ts";
import { bcmsPrivate } from "../../../../bcms-private";
import { bcmsPublic } from "../../../../bcms-public";
import ArticlesList from "../../../../components/articles/List";
import ContentManager from "../../../../components/ContentManager";
import Layout from "../../../../layouts/Layout.astro";
import { articleToLight } from "../../../../utils/article";
import {
  getCountryCode,
  getLanguageCode,
  getSupportedCountries,
  getSupportedLanguages,
} from "../../../../utils/localization";

export async function getStaticPaths() {
  // Get supported countries and languages as full names
  const countries = getSupportedCountries();
  const languages = getSupportedLanguages();

  const paths = [];
  for (const country of countries) {
    for (const language of languages) {
      paths.push({
        params: { country, language },
      });
    }
  }

  return paths;
}

const { country, language } = Astro.params;

// Convert full names back to codes for internal logic
const countryCode = getCountryCode(country ?? "");
const languageCode = getLanguageCode(language ?? "");

const articlesPageEntry = (await bcmsPrivate.entry.getBySlug(
  "articles",
  "articles-page",
)) as ArticlesPageEntry;
const articlesPageMeta = articlesPageEntry.meta.en as ArticlesPageEntryMetaItem;
const articleEntries = (await bcmsPrivate.entry.getAll(
  "article",
)) as ArticleEntry[];
const lightArticles = articleEntries.map((e) => {
  return articleToLight(e, languageCode);
});

const clientConfig = bcmsPublic.getConfig();
---

<Layout
  title={`${articlesPageMeta.seo?.title ?? articlesPageMeta.title} - Flavour Fushion`}
>
  <div class="container pt-24 pb-8 md:pb-16 lg:pt-[104px] lg:pb-[120px]">
    <ContentManager
      items={articlesPageMeta.headline?.nodes ?? []}
      className="articlesPage--title text-xl leading-[1.2] font-medium text-center text-appGray-700 mb-8 md:text-3xl lg:text-[56px] lg:leading-[1.2] lg:mb-10"
    />
    <ArticlesList
      articles={lightArticles}
      bcmsConfig={clientConfig}
      country={countryCode}
      language={languageCode}
      client:load
    />
  </div>
</Layout>
